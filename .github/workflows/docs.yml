name: "Docs"

on:
  workflow_dispatch:
  workflow_call:

jobs:
  docs:
    name: Check Autogenerated Documentation
    runs-on: [linux, self-hosted, x64, large]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Build Juju client
        run: |
          go install -v -tags minimal ./cmd/juju

      - name: Install sphinx dependencies
        run: |
          python -m venv venv
          source venv/bin/activate
          python -m pip install --upgrade --no-cache-dir pip setuptools
          python -m pip install --exists-action=w --no-cache-dir -r docs/.sphinx/requirements.txt

      - name: Make documentation
        run: |
          make docs-html

      - name: Check for changes
        run: |
          git add -A
          git rm -rf --quiet --cached venv/
          if [[ -n $(git diff HEAD) ]]; then
            # Print the full diff for debugging purposes
            git diff HEAD
            echo "*****"
            echo "The following generated documentation has been modified:"
            git diff --name-status HEAD
            echo "Please regenerate these files and check in the changes."
            echo ""
            echo "When running locally, the CLI documentation is generated by the version of juju on your path, NOT the version in the tree"
            echo "To regenerate the documentation locally, install the juju CLI from your local tree and build the docs with:"
            echo "    make juju docs-html"
            echo ""
            echo "*****"
            exit 1
          fi